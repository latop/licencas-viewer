<!DOCTYPE html>
<html lang="pt-BR" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <title>Consulta de Licen√ßas por Cliente</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root {
      --bg: #f5f5f7;
      --text: #222;
      --card-bg: #ffffff;
      --card-border: rgba(0,0,0,0.05);
      --subtext: #666;
      --chip-bg: #eef2ff;
      --chip-border: #c7d2fe;
      --chip-text: #3730a3;
      --btn-bg: #2563eb;
      --btn-bg-hover: #1d4ed8;
      --btn-text: #ffffff;
      --result-bg: #f9fafb;
      --result-border: #dddddd;
      --error: #b91c1c;
      --ok-bg: #dcfce7;
      --ok-text: #166534;
      --warn-bg: #ffedd5;
      --warn-text: #c2410c;
      --exp-bg: #fee2e2;
      --exp-text: #b91c1c;
    }

    [data-theme="dark"] {
      --bg: #020617;
      --text: #e5e7eb;
      --card-bg: #020617;
      --card-border: rgba(148,163,184,0.4);
      --subtext: #9ca3af;
      --chip-bg: #111827;
      --chip-border: #4b5563;
      --chip-text: #e5e7eb;
      --btn-bg: #2563eb;
      --btn-bg-hover: #1d4ed8;
      --btn-text: #f9fafb;
      --result-bg: #020617;
      --result-border: #1f2937;
      --error: #fecaca;
      --ok-bg: #064e3b;
      --ok-text: #bbf7d0;
      --warn-bg: #78350f;
      --warn-text: #fed7aa;
      --exp-bg: #450a0a;
      --exp-text: #fecaca;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 24px;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--text);
      transition: background .2s, color .2s;
    }

    .page {
      max-width: 1200px;
      margin: 0 auto;
    }

    h1 {
      margin: 0 0 4px;
      font-size: 1.9rem;
    }

    .subtitle {
      margin: 0 0 12px;
      color: var(--subtext);
      font-size: .9rem;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }

    .btn-main {
      border-radius: 999px;
      border: none;
      padding: 8px 18px;
      font-size: .9rem;
      cursor: pointer;
      background: var(--btn-bg);
      color: var(--btn-text);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }

    .btn-main:hover {
      background: var(--btn-bg-hover);
    }

    .btn-main:disabled {
      opacity: .7;
      cursor: default;
    }

    .theme-toggle {
      border-radius: 999px;
      border: 1px solid var(--card-border);
      padding: 4px 12px;
      font-size: .8rem;
      cursor: pointer;
      background: var(--card-bg);
      color: var(--text);
      white-space: nowrap;
    }

    .top-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .view-tabs {
      display: inline-flex;
      border-radius: 999px;
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      padding: 2px;
      gap: 2px;
      margin: 8px 0 16px;
      flex-wrap: wrap;
    }

    .view-tab {
      border-radius: 999px;
      border: none;
      padding: 6px 12px;
      font-size: .8rem;
      cursor: pointer;
      background: transparent;
      color: var(--subtext);
      white-space: nowrap;
    }

    .view-tab.active {
      background: var(--btn-bg);
      color: var(--btn-text);
    }

    .section {
      display: none;
    }

    .section.active {
      display: block;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 16px;
    }

    .card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 16px;
      min-height: 150px;
      box-shadow: 0 4px 10px var(--card-border);
      display: flex;
      flex-direction: column;
      border-left: 4px solid transparent;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      align-items: baseline;
      margin-bottom: 6px;
    }

    .company-name {
      font-weight: 600;
      font-size: 1rem;
    }

    .code-pill {
      padding: 3px 10px;
      border-radius: 999px;
      background: var(--chip-bg);
      color: var(--chip-text);
      border: 1px solid var(--chip-border);
      font-size: .75rem;
      white-space: nowrap;
    }

    .meta {
      font-size: .8rem;
      color: var(--subtext);
      margin-bottom: 6px;
    }

    .actions-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 8px;
    }

    .status-text {
      font-size: .8rem;
      color: var(--subtext);
    }

    .result {
      flex: 1;
      background: var(--result-bg);
      border-radius: 8px;
      padding: 10px;
      border: 1px dashed var(--result-border);
      font-size: .85rem;
      overflow: auto;
    }

    .result.empty {
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--subtext);
      font-style: italic;
    }

    .value-main {
      font-weight: 700;
      margin-bottom: 4px;
    }

    .value-formatted {
      font-size: .85rem;
      color: var(--subtext);
    }

    .error {
      color: var(--error);
    }

    .status-pill {
      padding: 2px 8px;
      border-radius: 999px;
      font-size: .75rem;
      font-weight: 600;
      white-space: nowrap;
    }

    .status-ok {
      background: var(--ok-bg);
      color: var(--ok-text);
    }

    .status-warning {
      background: var(--warn-bg);
      color: var(--warn-text);
    }

    .status-expired {
      background: var(--exp-bg);
      color: var(--exp-text);
    }

    .card.ok       { border-left-color: #16a34a; }
    .card.warning  { border-left-color: #f97316; }
    .card.expired  { border-left-color: #dc2626; }

    @media (max-width: 600px) {
      body { padding: 16px; }
      .top-bar { align-items: flex-start; }
      .top-actions { justify-content: flex-start; }
    }
  </style>
</head>
<body>
  <div class="page">
    <div class="top-bar">
      <div>
        <h1>Consulta de Licen√ßas por Cliente</h1>
        <p class="subtitle">
          Um clique em <strong>‚ÄúConsultar todas as licen√ßas‚Äù</strong> faz GET em
          <code>/api/licenca?empresa=C√ìDIGO</code> para todos os clientes de uma vez.
        </p>
      </div>
      <div class="top-actions">
        <button id="btnConsultarTodos" class="btn-main">
          üîÑ Consultar todas as licen√ßas
        </button>
        <button id="themeToggle" class="theme-toggle">üåó Tema escuro</button>
      </div>
    </div>

    <div class="view-tabs">
      <button class="view-tab active" data-view="viewStatus">Op√ß√£o 3 ‚Äì Status (padr√£o)</button>
      <button class="view-tab" data-view="viewCompact">Op√ß√£o 2 ‚Äì Compacta / Mobile</button>
    </div>

    <!-- Op√ß√£o 3: status de vencimento (padr√£o) -->
    <section id="viewStatus" class="section active">
      <div class="grid" id="gridStatus"></div>
    </section>

    <!-- Op√ß√£o 2: compacta / mobile -->
    <section id="viewCompact" class="section">
      <div class="grid" id="gridCompact"></div>
    </section>
  </div>

<script>
const API_BASE_URL = "https://siglawebapi.azurewebsites.net/api/licenca";

const COMPANIES = [
  { name:"MODERN", code:"MWM", tipo:"Licen√ßa principal" },
  { name:"SIDERAL", code:"SID", tipo:"Licen√ßa principal" },
  { name:"TMA (Sideral)", code:"TMA", tipo:"Subsistema / Filial" },
  { name:"JOAB", code:"FSB", tipo:"Licen√ßa principal" },
  { name:"LEVU A√©rea", code:"LVU", tipo:"A√©rea" },
  { name:"LEVU Funcion√°rios", code:"LLL", tipo:"Funcion√°rios" },
  { name:"BRASPRESS A√©rea", code:"BPC", tipo:"A√©rea" },
  { name:"BRASPRESS Funcion√°rios", code:"BAA", tipo:"Funcion√°rios" },
  { name:"AVION A√©rea", code:"AEB", tipo:"A√©rea" },
  { name:"AVION Funcion√°rios", code:"AEE", tipo:"Funcion√°rios" },
  { name:"GARCIA", code:"GAR", tipo:"Licen√ßa principal" }
];

// Guardar refer√™ncias por c√≥digo
const viewState = {
  status: {},  // Op√ß√£o 3
  compact: {}  // Op√ß√£o 2
};

// ---- Utilit√°rios de datas ----
function parseDateFromDDMMAAAA(raw) {
  const s = String(raw).trim();
  if (!/^\d{8}$/.test(s)) return null;
  const dd = parseInt(s.slice(0,2), 10);
  const mm = parseInt(s.slice(2,4), 10);
  const yyyy = parseInt(s.slice(4), 10);
  if (dd < 1 || dd > 31 || mm < 1 || mm > 12) return null;
  return new Date(yyyy, mm - 1, dd);
}

function formatDate(raw) {
  const d = parseDateFromDDMMAAAA(raw);
  if (!d) return null;
  const dd = String(d.getDate()).padStart(2,"0");
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const yyyy = d.getFullYear();
  return `${dd}/${mm}/${yyyy}`;
}

function calcStatus(raw) {
  const d = parseDateFromDDMMAAAA(raw);
  if (!d) return { label: "Data inv√°lida", type: "warning", days: null };

  const today = new Date();
  today.setHours(0,0,0,0);
  d.setHours(0,0,0,0);

  const diffMs = d - today;
  const diffDays = Math.round(diffMs / (1000*60*60*24));

  if (diffDays < 0) {
    return { label: "Vencida h√° " + Math.abs(diffDays) + " dia(s)", type: "expired", days: diffDays };
  }
  if (diffDays <= 30) {
    return { label: "A vencer em " + diffDays + " dia(s)", type: "warning", days: diffDays };
  }
  return { label: "OK por " + diffDays + " dia(s)", type: "ok", days: diffDays };
}

// ---- Chamada √† API ----
async function fetchLicense(code) {
  const url = API_BASE_URL + "?empresa=" + encodeURIComponent(code);
  const resp = await fetch(url);
  const text = await resp.text();
  if (!resp.ok) {
    throw new Error(text || ("HTTP " + resp.status));
  }
  return text.replace(/^"+|"+$/g, "").trim();
}

// ---- Renderiza√ß√µes ----

// Compacta / mobile (Op√ß√£o 2)
function renderCompact(container, rawValue) {
  container.classList.remove("empty");
  container.innerHTML = "";

  const main = document.createElement("div");
  main.className = "value-main";
  main.textContent = rawValue;
  container.appendChild(main);

  const fmt = formatDate(rawValue);
  if (fmt) {
    const f = document.createElement("div");
    f.className = "value-formatted";
    f.textContent = "V√°lido at√©: " + fmt;
    container.appendChild(f);
  }
}

// Status de vencimento (Op√ß√£o 3)
function renderStatus(card, resultEl, statusPill, rawValue) {
  resultEl.classList.remove("empty");
  resultEl.innerHTML = "";

  const main = document.createElement("div");
  main.className = "value-main";
  main.textContent = rawValue;
  resultEl.appendChild(main);

  const fmt = formatDate(rawValue);
  if (fmt) {
    const f = document.createElement("div");
    f.className = "value-formatted";
    f.textContent = "V√°lido at√©: " + fmt;
    resultEl.appendChild(f);

    const st = calcStatus(rawValue);
    statusPill.textContent = st.label;
    statusPill.className = "status-pill " +
      (st.type === "ok" ? "status-ok" :
       st.type === "warning" ? "status-warning" : "status-expired");

    card.classList.remove("ok","warning","expired");
    card.classList.add(st.type);
  } else {
    statusPill.textContent = "N√£o foi poss√≠vel interpretar a data";
    statusPill.className = "status-pill status-warning";
    card.classList.remove("ok","warning","expired");
  }
}

// ---- Cria√ß√£o dos cards ----

// Op√ß√£o 2 ‚Äì compacta
function createCardCompact(company) {
  const card = document.createElement("div");
  card.className = "card";

  const header = document.createElement("div");
  header.className = "card-header";

  const name = document.createElement("div");
  name.className = "company-name";
  name.textContent = company.name;

  const pill = document.createElement("div");
  pill.className = "code-pill";
  pill.textContent = company.code;

  header.appendChild(name);
  header.appendChild(pill);

  const meta = document.createElement("div");
  meta.className = "meta";
  meta.textContent = company.tipo;

  const actionsRow = document.createElement("div");
  actionsRow.className = "actions-row";

  const status = document.createElement("span");
  status.className = "status-text";
  status.textContent = "Aguardando consulta.";

  const filler = document.createElement("span");
  filler.textContent = "";

  actionsRow.appendChild(status);
  actionsRow.appendChild(filler);

  const result = document.createElement("div");
  result.className = "result empty";
  result.textContent = "Use ‚ÄúConsultar todas as licen√ßas‚Äù para carregar os dados.";

  card.appendChild(header);
  card.appendChild(meta);
  card.appendChild(actionsRow);
  card.appendChild(result);

  viewState.compact[company.code] = {
    resultEl: result,
    statusEl: status
  };

  return card;
}

// Op√ß√£o 3 ‚Äì status de vencimento
function createCardStatus(company) {
  const card = document.createElement("div");
  card.className = "card";

  const header = document.createElement("div");
  header.className = "card-header";

  const name = document.createElement("div");
  name.className = "company-name";
  name.textContent = company.name;

  const pill = document.createElement("div");
  pill.className = "code-pill";
  pill.textContent = company.code;

  header.appendChild(name);
  header.appendChild(pill);

  const meta = document.createElement("div");
  meta.className = "meta";
  meta.textContent = company.tipo;

  const actionsRow = document.createElement("div");
  actionsRow.className = "actions-row";

  const statusPill = document.createElement("span");
  statusPill.className = "status-pill status-warning";
  statusPill.textContent = "Sem dados";

  const statusText = document.createElement("span");
  statusText.className = "status-text";
  statusText.textContent = "";

  actionsRow.appendChild(statusPill);
  actionsRow.appendChild(statusText);

  const result = document.createElement("div");
  result.className = "result empty";
  result.textContent = "Clique em ‚ÄúConsultar todas as licen√ßas‚Äù para ver a validade.";

  card.appendChild(header);
  card.appendChild(meta);
  card.appendChild(actionsRow);
  card.appendChild(result);

  viewState.status[company.code] = {
    cardEl: card,
    resultEl: result,
    statusPillEl: statusPill,
    statusTextEl: statusText
  };

  return card;
}

// ---- Consultar todas ----
async function consultarTodas() {
  const btn = document.getElementById("btnConsultarTodos");
  btn.disabled = true;
  btn.textContent = "Consultando todas...";

  // Estado inicial de "consultando"
  COMPANIES.forEach(c => {
    const vc = viewState.compact[c.code];
    if (vc) {
      vc.statusEl.textContent = "Consultando...";
      vc.resultEl.classList.add("empty");
      vc.resultEl.textContent = "Consultando API...";
    }
    const vs = viewState.status[c.code];
    if (vs) {
      vs.statusPillEl.textContent = "Carregando...";
      vs.statusPillEl.className = "status-pill status-warning";
      vs.resultEl.classList.add("empty");
      vs.resultEl.textContent = "Consultando API...";
      vs.cardEl.classList.remove("ok","warning","expired");
    }
  });

  for (const c of COMPANIES) {
    let value;
    try {
      value = await fetchLicense(c.code);
    } catch (e) {
      const msg = "Erro: " + e.message;

      const vc = viewState.compact[c.code];
      if (vc) {
        vc.resultEl.classList.remove("empty");
        vc.resultEl.innerHTML = "<span class='error'>" + msg + "</span>";
        vc.statusEl.textContent = "Erro";
      }

      const vs = viewState.status[c.code];
      if (vs) {
        vs.resultEl.classList.remove("empty");
        vs.resultEl.innerHTML = "<span class='error'>" + msg + "</span>";
        vs.statusPillEl.textContent = "Erro";
        vs.statusPillEl.className = "status-pill status-expired";
        vs.cardEl.classList.add("expired");
        if (vs.statusTextEl) vs.statusTextEl.textContent = "";
      }
      continue;
    }

    const vc = viewState.compact[c.code];
    if (vc) {
      renderCompact(vc.resultEl, value);
      vc.statusEl.textContent = "OK";
    }

    const vs = viewState.status[c.code];
    if (vs) {
      renderStatus(vs.cardEl, vs.resultEl, vs.statusPillEl, value);
      if (vs.statusTextEl) vs.statusTextEl.textContent = "";
    }
  }

  btn.disabled = false;
  btn.textContent = "üîÑ Consultar todas as licen√ßas";
}

// ---- Inicializa√ß√£o ----
function initViews() {
  const gridStatus = document.getElementById("gridStatus");
  const gridCompact = document.getElementById("gridCompact");

  COMPANIES.forEach(c => {
    gridStatus.appendChild(createCardStatus(c));
    gridCompact.appendChild(createCardCompact(c));
  });
}

function initTabs() {
  const tabs = document.querySelectorAll(".view-tab");
  const sections = document.querySelectorAll(".section");

  tabs.forEach(tab => {
    tab.addEventListener("click", () => {
      const target = tab.getAttribute("data-view");

      tabs.forEach(t => t.classList.remove("active"));
      tab.classList.add("active");

      sections.forEach(sec => {
        if (sec.id === target) sec.classList.add("active");
        else sec.classList.remove("active");
      });
    });
  });
}

function initThemeToggle() {
  const root = document.documentElement;
  const btn = document.getElementById("themeToggle");

  btn.addEventListener("click", () => {
    const current = root.getAttribute("data-theme") || "light";
    const next = current === "light" ? "dark" : "light";
    root.setAttribute("data-theme", next);
    btn.textContent = next === "light" ? "üåó Tema escuro" : "üåû Tema claro";
  });
}

function initConsultarTodas() {
  const btn = document.getElementById("btnConsultarTodos");
  btn.addEventListener("click", consultarTodas);
}

function init() {
  initViews();
  initTabs();
  initThemeToggle();
  initConsultarTodas();
}

init();
</script>
</body>
</html>
